jQuery.cookie=function(a,b,c){if(arguments.length>1&&"[object Object]"!==String(b)){if(c=jQuery.extend({},c),(null===b||void 0===b)&&(c.expires=-1),"number"==typeof c.expires){var d=c.expires,e=c.expires=new Date;e.setDate(e.getDate()+d)}return b=String(b),document.cookie=[encodeURIComponent(a),"=",c.raw?b:encodeURIComponent(b),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}c=b||{};var f,g=c.raw?function(a){return a}:decodeURIComponent;return(f=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(document.cookie))?g(f[1]):null};var Ebla={};Ebla.debug=function(){{var a=!1,b=function(a){Ebla.debug.debugMode&&Ebla.flashMessage&&Ebla.flashMessage.post(a)};!function(){window.location.href.match(/debug/)&&(a=!0),window.debug||(window.debug=b)}()}return{debugMode:a,debug:b}}(),Ebla.flashMessage=function(){var a=null,b=null,c=2e3,d=function(){a=$("<div />").attr("id","flash-message-box").html("<ul></ul>").css({opacity:0}).appendTo(Ebla.elements.$container),a.hover(function(){clearTimeout(b)},function(){g()})},e=function(c){window.console&&window.console.log&&console.log(c),a&&(a.find("ul").prepend("<li>"+c+"</li>"),clearTimeout(b),Ebla.compatibility.canAnimate?a.stop().css({display:"block"}).animate({opacity:1},500,function(){g()}):(a.css({opacity:1,display:"block"}),g()))},f=function(){Ebla.compatibility.canAnimate?a.animate({opacity:0},500,function(){a.html("<ul></ul>").css({display:"none"})}):(a.css({opacity:0,display:"none"}),a.html("<ul></ul>")),window.console&&window.console.log&&console.log("-------------")},g=function(){b=setTimeout(f,c)};return{post:e,domLoad:d}}(),Ebla.compatibility=function(){{var a={clickEvent:null,keyEvent:null,isIe:!1,isIeOld:!1,isIe8:!1,isIe7:!1,isIe6:!1,isKindle:!1,isAndroid:!1,isMobileSafari:!1,isMobile:!1,hasCssAnimations:!1,hasCssColumns:!1,hasCssHyphens:!1,hasLocalStorage:!1,canAnimate:!0,canOpenBrowserWindows:!0,needsDoubleWidthFix:!1,hasIframeDimensionsBug:!1,hasNoScrollEventBug:!1},b=function(){a.isIe=$.browser.msie||!1,a.isIe&&(a.isIeOld=parseInt($.browser.version,10)<9,a.isIeOld&&(a.isIe8=8===a.isIe.version,a.isIe7=7===a.isIe.version,a.isIe6=6===a.isIe.version))},c=function(){a.isKindle=!!navigator.userAgent.match(/Kindle/),a.isAndroid=!(!navigator.userAgent.match(/Android/)&&!navigator.userAgent.match(/Silk/)),a.isMobileSafari=!!navigator.userAgent.match(/AppleWebKit.*Mobile/),a.isMobile=Modernizr.mq("only all and (max-device-width: 480px)")},d=function(){a.isKindle&&(a.hasLocalStorage=!1,a.keyEvent="keyup",a.needsDoubleWidthFix=!0,a.canOpenBrowserWindows=!1,a.hasNoScrollEventBug=!0),a.isAndroid&&(a.needsDoubleWidthFix=!0,a.hasIframeDimensionsBug=!0)};!function(){a.hasCssColumns=Modernizr.csscolumns,a.hasCssAnimations=Modernizr.cssanimations,a.hasCssHyphens=Modernizr.testAllProps("hyphens"),a.clickEvent=Modernizr.touch?"touchend":"mousedown",a.hasLocalStorage=Modernizr.localstorage,a.keyEvent="keydown",b(),c(),d()}()}return a}(),Ebla.elements={$window:$(window),$document:$(document),$body:null,container:null,$container:null,main:null,sandbox:null,$sandbox:null,$header:null,$footer:null,frame:null,$frame:null,domLoad:function(){this.container=document.getElementById("container"),this.$container=$("#container"),this.main=document.getElementById("main"),this.sandbox=document.getElementById("sandbox"),this.$sandbox=$("#sandbox"),this.$header=$(".header"),this.$footer=$(".footer"),this.$body=$("body"),this.frame=window.frames.sandbox.document.getElementsByTagName("body")[0],this.$frame=$(this.frame)}},Ebla.controls=function(){var a=!1,b=function(){a?c():d()},c=function(){Ebla.toc.hide(),Ebla.compatibility.canAnimate?(Ebla.elements.$header.stop().animate({opacity:0},250,function(){Ebla.elements.$header.removeClass("show"),a=!1}),Ebla.elements.$footer.stop().animate({opacity:0},250,function(){Ebla.elements.$footer.css({visibility:"hidden"})})):(Ebla.elements.$header.removeClass("show"),Ebla.elements.$footer.css({opacity:0,visibility:"hidden"}),a=!1)},d=function(){Ebla.elements.$header.addClass("show"),Ebla.compatibility.canAnimate?(Ebla.elements.$header.stop().animate({opacity:1},250,function(){a=!0}),Ebla.elements.$footer.stop().css({visibility:"visible"}).animate({opacity:1},250)):(Ebla.elements.$header.css({opacity:1}),Ebla.elements.$footer.css({opacity:1,visibility:"visible"}),a=!0)},e=function(){var a=$(".shim-bck"),b=$(".shim-fwd");b.css(Ebla.book.componentIndex===Ebla.book.components.length-1&&Ebla.navigation.position-Ebla.layout.pageSize<=Ebla.layout.pageEnd?{display:"none"}:{display:"block"}),a.css(0===Ebla.book.componentIndex&&0===Ebla.navigation.position?{display:"none"}:{display:"block"})};return{controlsShowing:a,toggle:b,hide:c,show:d,showHideNavArrows:e}}(),Ebla.data=function(){var a=function(a,b){a=a+"-"+Ebla.book.metaData.id,Ebla.compatibility.hasLocalStorage?localStorage.setItem(a,b):$.cookie(a,b,{expires:14,path:"/"})},b=function(a){return a=a+"-"+Ebla.book.metaData.id,Ebla.compatibility.hasLocalStorage?localStorage.getItem(a):$.cookie(a)};return{store:a,retrieve:b}}(),Ebla.images=function(){var a=[{src:Ebla.compatibility.hasCssAnimations?"images/loader.png":"images/loader.gif",callback:function(){$("#loader-icon").css("display","block")}},{src:"images/icons.png"}],b=!1,c=function(c,e){var f={};f.src=c,e&&(f.callback=e),b?d(f):a.push(f)},d=function(a){var b=new Image;b.src=a.src,debug("Ebla.images: preloading "+a.src),a.callback&&$(b).bind("load",function(){a.callback()})},e=function(){for(;a.length;)d(a.pop());b=!0};return{preload:c,domLoad:e}}(),Ebla.layout={fontSize:16,lineHeight:26,width:null,height:null,pageSize:null,pageEnd:null,pageStart:0,calculateDimensions:function(a){a?(this.setFontSize(),this.setLineHeight(),Ebla.compatibility.hasCssColumns||this.strictRhythm()):(Ebla.elements.frame.style.top=0,Ebla.elements.frame.style.left=0),this.setPageWidth(),this.setPageHeight(),this.setPageSize(),this.setPageEnd()},setFontSize:function(){this.fontSize=Ebla.elements.$frame.css("font-size")},setLineHeight:function(){var a,b,c=this.fontSize,d=Ebla.elements.frame;window.getComputedStyle?a=document.defaultView.getComputedStyle(d,null).getPropertyValue("line-height"):d.currentStyle&&(a=d.currentStyle.lineHeight),isNaN(a)?-1!==a.indexOf("px")?a=parseInt(a,10):-1!==a.indexOf("em")||-1!==a.indexOf("%")?a=Math.round(parseInt(a,10)*parseInt(c,10)):(b=document.createElement("p"),b.innerHTML="m",b.style.visibility="hidden",b.style.fontSize="inherit",d.appendChild(b),a=b.clientHeight,d.removeChild(b)):a=Math.round(a*parseInt(c,10)),this.lineHeight=a},setPageWidth:function(){var a,b=Ebla.elements.main,c=Ebla.elements.frame,d=Ebla.elements.sandbox,e=this.fontSize;b.style.fontSize=e,a=b.offsetWidth,d.style.width=a+"px",c.style.WebkitColumnWidth=a+"px",c.style.MozColumnWidth=a+"px",c.style.columnWidth=a+"px",Ebla.compatibility.needsDoubleWidthFix&&(c.style.minWidth="200%"),this.width=a},setPageHeight:function(){var a,b,c=Ebla.elements.main,d=Ebla.elements.frame,e=Ebla.elements.sandbox,f=this.lineHeight;window.innerHeight?b=window.innerHeight:document.documentElement.clientHeight&&(b=document.documentElement.clientHeight),Ebla.compatibility.hasIframeDimensionsBug,Ebla.compatibility.isMobile?(c.style.paddingTop=.84*f+"px",a=Math.floor(b/f-2)*f):(c.style.paddingTop=2*f+"px",a=Math.floor(b/f-4)*f),c.style.height=a+"px",d.style.height=a+"px",e.style.height=a+"px",this.height=a},getScrollWidth:function(a,b){var c,d,e,f,g,h,i,j=a.scrollWidth;if(j===b&&a.getBoundingClientRect){for(c=a.getElementsByTagName("*"),d=a.getBoundingClientRect(),e=d.left,f=d.right,i=c.length-1;i>=0;--i)h=c[i].getBoundingClientRect(),e=Math.min(e,h.left),f=Math.max(f,h.right);e=Math.abs(e),f=Math.abs(f),j=e+f}else if(j===2*b&&Ebla.compatibility.needsDoubleWidthFix){for(c=a.getElementsByTagName("*"),f=0,g=this.height,i=c.length-1;i>=0;--i)h=c[i].getBoundingClientRect(),f=Math.max(f,h.right),g=Math.max(g,h.bottom);f=Math.abs(f),g=Math.abs(g),f===b&&(j=b,g>this.height&&(j*=2))}return-j},getScrollHeight:function(a,b){return-Math.ceil(a.scrollHeight/b)*b},setPageSize:function(){this.pageSize=Ebla.compatibility.hasCssColumns?this.width:this.height},setPageEnd:function(){var a=Ebla.elements.frame,b=this.width,c=this.height;this.pageEnd=Ebla.compatibility.hasCssColumns?this.getScrollWidth(a,b):this.getScrollHeight(a,c)},hyphenation:function(a){for(var b,c=$(a).find("*"),d=c.length;d--;)b=$(c[d]),"justify"===b.css("text-align")&&"inline"!==b.css("display")&&(Ebla.compatibility.hasCssHyphens?(b.css("-webkit-hyphens","auto"),b.css("-moz-hyphens","auto"),b.css("-hyphens","auto")):b.css("text-align","left"))},strictRhythm:function(){for(var a=Ebla.elements.frame,b=this.lineHeight,c=$(a).find("img","object"),d=c.length;d--;){for(var e,f,g,h,i=c[d],j=$(i),k=j.parent(),l=k.contents(),m=!0,n=l.length-1;n>=0;n--)if(h=l[n],h.length&&"#text"===h.nodeName&&h.length>1||h.innerHTML&&h.innerHTML.length>0){m=!1;break}m&&(e=j.height(),f=Math.ceil(e/b)*b,g=f-e,i.style.cssText="display:block !important;padding-bottom:"+g+"px !important;",debug("Ebla.layout: Applying strict rhythm to "+i.src))}}},Ebla.loader={$loader:null,loading:!1,loaderType:null,loaderInterval:null,domLoad:function(){this.$loader=$("#loader"),Ebla.compatibility.hasCssAnimations||this.$loader.addClass("gif")},show:function(a){this.loading=!0,this.$loader.css({display:"block"}).animate({opacity:1},250,function(){this.loading=!1,a&&a()})},hide:function(a){return Ebla.compatibility.canAnimate?void(this.$loader&&(this.loading=!0,this.$loader.animate({opacity:0},500,function(){Ebla.loader.loading=!1,Ebla.loader.$loader.css({display:"none"}),a&&a()}))):(this.$loader.css({opacity:0,display:"none"}),clearInterval(this.loaderInterval),void(a&&a()))}},Ebla.navigation={position:0,hackBack:!1,scrollPositionFixInterval:null,moveTo:function(a){var b=Ebla.elements.frame;Ebla.compatibility.hasCssColumns?b.style.left=a+"px":b.style.top=a+"px",Ebla.progress.updateProgressBar(),Ebla.placesaver.save(),Ebla.controls.showHideNavArrows()},turnPage:function(a){var b,c=!0;"forward"===a?(this.hackBack=!1,this.position<=Ebla.layout.pageEnd+Ebla.layout.pageSize&&(Ebla.book.componentIndex===Ebla.book.components.length-1?c=!1:(b=Ebla.book.components[Ebla.book.componentIndex+1],this.updateComponent(b),c=!1)),c&&(this.position=this.position-Ebla.layout.pageSize)):"backwards"===a&&(this.position>=Ebla.layout.pageStart?0===Ebla.book.componentIndex?c=!1:(b=Ebla.book.components[Ebla.book.componentIndex-1],this.hackBack=!0,this.updateComponent(b),c=!1):this.position=this.position+Ebla.layout.pageSize),c&&(debug("Ebla.navigation: moving position to "+this.position),this.moveTo(this.position)),Ebla.controls.hide()},updateComponentSrc:function(a,b,c){Ebla.loader.show(function(){Ebla.elements.$sandbox.attr("src",a),Ebla.elements.$sandbox.bind("load.update",function(){Ebla.controls.hide(),Ebla.loader.hide(),Ebla.elements.$sandbox.unbind("load.update"),0!==b?Ebla.navigation.position=Ebla.navigation.calculatePositionFromPercentageRead(b):c?Ebla.navigation.position=Ebla.navigation.calculatePositionFromHash(c):Ebla.navigation.hackBack?(Ebla.navigation.position=Ebla.layout.pageEnd+Ebla.layout.pageSize,Ebla.navigation.hackBack=!1):Ebla.navigation.position=0,Ebla.navigation.moveTo(Ebla.navigation.position)})})},updateComponent:function(a,b,c){b||(b=0),a===Ebla.book.component?(this.position=c?this.calculatePositionFromHash(c):this.calculatePositionFromPercentageRead(b),this.moveTo(this.position),Ebla.loader.hide(),debug("Ebla.navigation: Resetting current component "+Ebla.book.componentIndex+" ("+a+")")):(Ebla.book.componentIndex=$.inArray(a,Ebla.book.components),-1===Ebla.book.componentIndex&&(Ebla.book.componentIndex=0),debug("Ebla.navigation: Loading component "+Ebla.book.componentIndex+" ("+a+")"),this.updateComponentSrc(Ebla.book.metaData.location+a,b,c))},calculatePositionFromPercentageRead:function(a){return a>0?-(Math.floor(Math.abs(Ebla.layout.pageEnd)*(a/100)/Ebla.layout.pageSize)*Ebla.layout.pageSize):0},calculatePositionFromHash:function(a){debug("Ebla.navigation: searching component for hash ID: #"+a);var b,c,d=0;return c=Ebla.elements.$frame.find("#"+a),c.length>0&&(b=c.position(),d=Ebla.compatibility.hasCssColumns?-Math.floor(b.left/Ebla.layout.pageSize)*Ebla.layout.pageSize:-Math.floor(b.top/Ebla.layout.pageSize)*Ebla.layout.pageSize),d},fixInnerScroll:function(){$(window.frames.sandbox).unbind("scroll"),$(window.frames.sandbox).bind("scroll",function(b){b.preventDefault(),b.stopPropagation(),a()}),Ebla.compatibility.hasNoScrollEventBug&&($("<span/>").addClass("e-ink-fix").appendTo(Ebla.elements.$container),clearInterval(this.scrollPositionFixInterval),this.scrollPositionFixInterval=setInterval(function(){a()},100));var a=function(){window.frames.sandbox.document.body.scrollLeft>0&&(window.frames.sandbox.document.body.scrollLeft=0,debug("Ebla.navigation: Fixing unregistered scroll"))}}},Ebla.navigation.event={lastTouchEvent:null,lastTouchEventWasMove:null,init:function(){Ebla.elements.$document.bind(Ebla.compatibility.clickEvent,function(a){Ebla.navigation.event.handleClick(a)}),Modernizr.touch&&(Ebla.elements.$document.bind("touchstart",function(a){Ebla.navigation.event.storeTouchStart(a)}),Ebla.elements.$document.bind("touchmove",function(a){Ebla.navigation.event.storeTouchMove(a)}))}(),handleClick:function(a,b){if(!Ebla.loader.loading){var c=a.target;if(Ebla.toc.tocStatus())return void($(c).hasClass("overlay-shim-show")&&Ebla.toc.hide());if("A"!==a.target.nodeName&&(c=$(a.target).closest("a")[0]),c&&"A"===c.nodeName){var d,e,f=$(c).attr("href");return void(b&&!f.match(/http/)?(e=f.split("#")[1],d=f.split("#")[0],a.preventDefault(),!Ebla.compatibility.isIeOld&&a.stopPropagation&&a.stopPropagation(),Ebla.navigation.updateComponent(d,null,e)):b?Ebla.compatibility.canOpenBrowserWindows?(a.preventDefault(),window.open(f)):window.location.href=f:b||"#"!==f.charAt(0)||a.preventDefault())}a.preventDefault();var g,h=a.originalEvent.touches?this.lastTouchEvent:a,i=h.pageX;b&&(i+=Ebla.elements.sandbox.offsetLeft),g=i/Ebla.elements.container.offsetWidth,g>.33&&.67>g&&!this.lastTouchEventWasMove?Ebla.controls.toggle():!Ebla.toc.tocStatus()&&(.33>=g||.45>g&&this.lastTouchEventWasMove)?Ebla.navigation.turnPage("backwards"):!Ebla.toc.tocStatus()&&(g>=.67||g>.55&&this.lastTouchEventWasMove)&&Ebla.navigation.turnPage("forward"),debug("Ebla.navigation.event: Detected click from "+(b?"frame":"window")+" at "+Math.round(100*g)+"%")}},storeTouchStart:function(a){this.lastTouchEvent=a.originalEvent.touches[0],this.lastTouchEventWasMove=!1},storeTouchMove:function(a){this.lastTouchEvent=a.originalEvent.touches[0],this.lastTouchEventWasMove=!0}},Ebla.navigation.keyboard=function(){var a=function(a){if(!Ebla.loader.loading)switch(debug("Ebla.navigation.keyboard: detected keypress "+a.keyCode),a.keyCode){case 37:case 33:case 80:if(Ebla.toc.tocStatus())return;Ebla.navigation.turnPage("backwards"),a.preventDefault();break;case 39:case 32:case 34:case 78:if(Ebla.toc.tocStatus())return;Ebla.navigation.turnPage("forward"),a.preventDefault();break;case 73:Ebla.controls.show(),Ebla.toc.toggle();break;case 88:Ebla.toc.hide()}};return{handleKeyDown:a}}(),Ebla.placesaver=function(){var a=function(a,b){a=a||Math.abs(Ebla.navigation.position)>0?Math.round(Ebla.navigation.position/Ebla.layout.pageEnd*100):0,b=b||Ebla.book.componentIndex,debug("Ebla.placesaver: Saving: "+a+"%, component "+Ebla.book.componentIndex+" (pos: "+Ebla.navigation.position+" of "+Ebla.layout.pageEnd+")"),Ebla.data.store("percentageRead",a),Ebla.data.store("componentIndex",b)},b=function(a,b){var c;a=a||Ebla.data.retrieve("percentageRead"),b=b||Ebla.data.retrieve("componentIndex"),debug("Ebla.placesaver: restore - component:"+b+", "+a+"% read"),a&&b?(c=Ebla.book.components[b],Ebla.navigation.updateComponent(c,a)):Ebla.loader.hide()};return{save:a,restore:b}}(),Ebla.progress={$progressBar:null,$progressFill:null,$percentThru:null,updateProgressBar:function(){var a,b,c,d;c=Ebla.book.contentSizes[Ebla.book.componentIndex],a=Ebla.book.cumulativeSizes[Ebla.book.componentIndex]-c,d=Math.abs(Ebla.navigation.position)/Math.abs(Ebla.layout.pageEnd),a+=c*d,b=(a/Ebla.book.contentLength*100).toFixed(2),Ebla.navigation.position<=Ebla.layout.pageEnd+Ebla.layout.pageSize&&Ebla.book.componentIndex===Ebla.book.components.length-1&&(b=100),debug("Ebla.progress: set current progress: "+b+"%"),this.$progressFill.css({width:b+"%"}),this.$percentThru.html(Math.round(b)+"%")},createProgressBar:function(){this.$progressBar=$("<div />").attr("class","progress-bar").prependTo(Ebla.elements.$footer);var a=$("<div />").attr("class","progress-bg").appendTo(this.$progressBar);this.$progressFill=$("<div />").attr("class","progress-fill").appendTo(a),this.$percentThru=$("<p />").attr("class","percent-thru").appendTo(Ebla.elements.$footer)},addProgressMarkers:function(){if(Ebla.book.contentMarkers.length>0){var a,b,c,d,e,f=$("<ol />").addClass("content-markers").appendTo(this.$progressBar),g=25,h=50;$.each(Ebla.book.contentMarkers,function(){a=this,b=((a.cumulativeSize-a.size)/Ebla.book.contentLength*100).toFixed(2),e=a.title.length<g?a.title:a.title.substring(0,g)+"…",c=$("<li />").css({left:b+"%"}).addClass("marker marker-left").appendTo(f),b>h&&c.addClass("marker-right").removeClass("marker-left"),d=$("<a />").attr("href",Ebla.book.metaData.location+a.hash).html("<span></span><strong>"+e+"</strong>").appendTo(c),d.bind("click",function(a){a.preventDefault(),!Ebla.compatibility.isIeOld&&a.stopPropagation&&a.stopPropagation();var b,c,d=$(this).attr("href");d=d.replace(Ebla.book.metaData.location,""),c=d.split("#")[1],b=d.split("#")[0],Ebla.navigation.updateComponent(b)})})}}},Ebla.resize=function(){var a=null,b={width:0,height:0},c=(function(){Ebla.elements.$window.bind("resize",function(){g()}),Ebla.elements.$window.bind("orientationchange",function(){h()})}(),function(){b=d()}),d=function(){return{width:Ebla.elements.$window.width(),height:Ebla.elements.$window.height()}},e=function(){return b},f=function(a){return a.width===Ebla.elements.$window.width()&&a.height===Ebla.elements.$window.height()},g=function(){Ebla.toc.tocStatus()||f(b)||(b=d(),Ebla.loader.show(),clearTimeout(a),a=setTimeout(function(){Ebla.compatibility.hasIframeDimensionsBug&&0!==window.orientation?window.location.reload():(debug("Ebla.resize: Resize debounced"),Ebla.layout.calculateDimensions(),Ebla.placesaver.restore())},500),debug("Ebla.resize: Resize detected"))},h=function(){Ebla.toc.tocStatus()&&(debug("Ebla.resize: Prepare resize when TOC disappears"),Ebla.toc.fireResizeOnHide()),debug("Ebla.resize: Rotated")};return{domLoad:c,cacheDimensions:d,getCurrentDimensions:e,testDimensions:f,resized:g,rotated:h}}(),Ebla.toc=function(){var a,b,c,d,e,f=!1,g=!1,h=!1,i=!1,j={width:0,height:0},k=function(){a=$("a.toc"),b=$(".nav"),c=$("<div />").addClass("overlay-shim").appendTo(Ebla.elements.$container),b.appendTo(c),d=$("<a />").attr("href","#").addClass("nav-close icon").text("close").appendTo(b),a.bind(Ebla.compatibility.clickEvent,function(){o()}),d.bind(Ebla.compatibility.clickEvent,function(){q()}),a.bind("click",function(a){a.preventDefault()}),d.bind("click",function(a){a.preventDefault()}),b.find("ol").length>0&&m()},l=function(){b.find("ol").length<1&&!g&&(g=!0,$.get(Ebla.book.metaData.location+"ebla.html",function(a){debug("Ebla.toc: TOC added dynamically"),b.append(a),m()}))},m=function(){e=b.find("ol a").bind("click",function(a){a.preventDefault(),!Ebla.compatibility.isIeOld&&a.stopPropagation&&a.stopPropagation();var b,c,d=$(this).attr("href");d=d.split(Ebla.book.metaData.location)[1],b=d.split("#")[0],c=d.split("#")[1],b!==Ebla.book.component?i=!0:(Ebla.navigation.position=0,Ebla.navigation.moveTo(Ebla.navigation.position)),q(function(){Ebla.navigation.updateComponent(b)})})},n=function(){return f},o=function(){f?q():p()},p=function(){debug("Ebla.toc: showing TOC"),f=!0,j=Ebla.resize.cacheDimensions(),Ebla.elements.$container.addClass("modal"),b.toggleClass("show"),c.toggleClass("overlay-shim-show"),Ebla.compatibility.canAnimate&&(c.stop().css({opacity:0}).animate({opacity:1},250),b.stop().css({opacity:0}).delay(250).animate({opacity:1},250))},q=function(a){debug("Ebla.toc: hiding TOC"),Ebla.elements.$container.removeClass("modal"),i||!f||Ebla.resize.testDimensions(j)||(h=!0),h&&!i&&(f=!1,h=!1,i=!1,Ebla.resize.resized()),Ebla.compatibility.canAnimate?(c.stop().css({opacity:1}).delay(250).animate({opacity:0},250,function(){f=!1,h=!1,i=!1,b.removeClass("show"),c.removeClass("overlay-shim-show"),a&&a()}),b.stop().css({opacity:1}).animate({opacity:0},250)):(b.removeClass("show"),c.removeClass("overlay-shim-show"),f=!1,h=!1,i=!1,a&&a())},r=function(){h=!0};return{tocShowing:f,toggle:o,show:p,hide:q,tocStatus:n,domLoad:k,createToc:l,fireResizeOnHide:r,preTocDimensions:j,initTocLinks:m}}(),Ebla.init={inited:!1,domLoaded:!1,windowLoaded:!1,sandboxLoaded:!1,_init:function(){$(document).ready(function(){Ebla.elements.domLoad(),Ebla.resize.domLoad(),Ebla.book.domLoad(),Ebla.images.domLoad(),Ebla.flashMessage.domLoad(),Ebla.toc.domLoad(),Ebla.loader.domLoad(),Ebla.init.domLoad()})}(),domLoad:function(){Ebla.elements.sandbox.setAttribute("scrolling","no"),Ebla.elements.$window.bind("load",function(){Ebla.init.windowLoad()}),$("#sandbox").bind("load",function(){Ebla.init.sandboxLoad()}),Ebla.compatibility.canAnimate||Ebla.elements.$body.addClass("no-animation"),Ebla.init.domLoaded=!0,debug("Ebla.init: DOM has loaded")},windowLoad:function(){debug("Ebla.init: window loaded"),Ebla.book.dataLoaded&&(Ebla.init.init(),Ebla.init.inited=!0,Ebla.placesaver.restore()),Ebla.init.windowLoaded=!0},sandboxLoad:function(){debug("Ebla.init: sandbox loaded"),Ebla.init.windowLoaded&&Ebla.book.dataLoaded&&(Ebla.init.init(!0),Ebla.init.inited=!0),Ebla.init.sandboxLoaded=!0},init:function(a){if(Ebla.book.component=Ebla.elements.sandbox.getAttribute("src").replace(Ebla.book.metaData.location,"").split("#")[0],!Ebla.book.component)return debug("Ebla.init: setting first component"),void Ebla.elements.sandbox.setAttribute("src",Ebla.book.metaData.location+Ebla.book.components[0]);Ebla.book.componentIndex=$.inArray(Ebla.book.component,Ebla.book.components),-1===Ebla.book.componentIndex&&(Ebla.book.componentIndex=0),debug("Ebla.init: Component "+Ebla.book.componentIndex+" has just loaded ("+Ebla.book.component+")"),Ebla.toc.createToc(),Ebla.elements.frame=window.frames.sandbox.document.getElementsByTagName("body")[0],Ebla.elements.$frame=$(Ebla.elements.frame);var b=$(window.frames.sandbox.document);Ebla.elements.frame.setAttribute("id","ebla-js"),Ebla.layout.hyphenation(Ebla.elements.frame),Ebla.layout.calculateDimensions(!0),Ebla.controls.showHideNavArrows(),b.bind(Ebla.compatibility.clickEvent,function(a){Ebla.navigation.event.handleClick(a,!0)}),b.bind(Ebla.compatibility.keyEvent,function(a){Ebla.navigation.keyboard.handleKeyDown(a),debug("Ebla.navigation.keyboard: key press on iframe")}),Ebla.elements.$document.unbind(Ebla.compatibility.keyEvent),Ebla.elements.$document.bind(Ebla.compatibility.keyEvent,function(a){Ebla.navigation.keyboard.handleKeyDown(a),debug("Ebla.navigation.keyboard: key press on window")}),b.bind("click",function(a){a.preventDefault()}),Modernizr.touch&&(b.bind("touchstart",function(a){Ebla.navigation.event.storeTouchStart(a,!0)}),b.bind("touchmove",function(a){Ebla.navigation.event.storeTouchMove(a,!0)})),Ebla.navigation.fixInnerScroll(),debug("Ebla.init: "+(a?"Component "+Ebla.book.componentIndex:"Ebla")+" init complete")}},Ebla.book={contentData:null,metaData:null,components:[],component:null,componentIndex:0,contentMarkers:[],contentSizes:[],cumulativeSizes:[],contentLength:0,dataLoaded:!1,domLoad:function(){window.bookData?Ebla.book.parseBookData(bookData):($.ajaxSetup({scriptCharset:"utf-8",contentType:"application/json; charset=utf-8"}),$.ajax({url:bookJson,dataType:"json",success:function(a){Ebla.book.parseBookData(a)},error:function(a){debug(a)}}))},parseBookData:function(a){Ebla.book.contentData=a.contentData,Ebla.book.metaData=a.metaData,Ebla.book.parseComponentData(a.contentData),debug("Ebla.book: Book data parsed"),Ebla.book.dataLoaded=!0,debug("Ebla.book: creating progress bar in book data"),Ebla.progress.createProgressBar(),Ebla.progress.addProgressMarkers(),Ebla.book.addBookMetaDataToPage(),!Ebla.init.inited&&Ebla.init.windowLoaded&&(debug("Ebla.book: initing after book data loaded"),Ebla.init.init(),Ebla.init.inited=!0,Ebla.placesaver.restore())},parseComponentData:function(a){var b,c;$.each(a,function(){b=this,c=b.hash.split("#")[0],-1===$.inArray(c,Ebla.book.components)&&Ebla.book.components.push(c),Ebla.book.contentLength+=b.size,Ebla.book.contentSizes.push(b.size),Ebla.book.cumulativeSizes.push(Ebla.book.contentLength),b.cumulativeSize=Ebla.book.contentLength,b.marker&&Ebla.book.contentMarkers.push(b),b.children&&Ebla.book.parseComponentData(b.children)})},addBookMetaDataToPage:function(){var a=($("title"),$("h1 cite")),b=$("h1 span.author");a.text().length<1&&a.text(Ebla.book.metaData.title),b.text().length<1&&b.text(Ebla.book.metaData.creator)}};